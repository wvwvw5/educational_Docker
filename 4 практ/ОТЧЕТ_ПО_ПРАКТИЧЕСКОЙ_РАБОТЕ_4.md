# ОТЧЕТ ПО ПРАКТИЧЕСКОЙ РАБОТЕ №4
## Настройка отслеживания БД в Grafana (Docker)

---

## ОГЛАВЛЕНИЕ
1. [Цель работы](#цель-работы)
2. [Используемое окружение](#используемое-окружение)
3. [Развертывание Grafana в Docker](#развертывание-grafana-в-docker)
4. [Добавление источников данных](#добавление-источников-данных)
5. [Развертывание баз данных в отдельном docker-compose](#развертывание-баз-данных-в-отдельном-docker-compose)
6. [Подготовка локальной БД на хосте](#подготовка-локальной-бд-на-хосте)
7. [Дашборд и визуализация](#дашборд-и-визуализация)
8. [Дополнительные материалы и скриншоты](#дополнительные-материалы-и-скриншоты)
9. [Выводы](#выводы)

---

## ЦЕЛЬ РАБОТЫ

Развернуть систему мониторинга на базе Grafana, подключив к ней несколько источников данных, включая локальную базу на хост-машине и базы, развернутые в Docker. Настроить визуализацию данных с датой и числовым столбцом и задокументировать процесс.

---

## ИСПОЛЬЗУЕМОЕ ОКРУЖЕНИЕ
- MacOS (Darwin 25.0.0), Docker Desktop 28.3.2
- Docker Compose v2.39.1
- Grafana 10.2.3 (контейнер)
- PostgreSQL 15 (контейнер)
- MySQL 8.2 (контейнер)
- SQLite 3.45 (локально на хосте)

---

## РАЗВЕРТЫВАНИЕ GRAFANA В DOCKER

1. **Создание рабочей структуры**
   ```bash
   mkdir -p "4 практ/grafana" "4 практ/databases" "4 практ/data"
   ```

2. **Общая сеть для сервисов** (создаем один раз, до запуска compose):
   ```bash
   docker network create grafana_net
   ```
   ```bash
   docker network ls | grep grafana_net
   # 43766febee16   grafana_net   bridge   local
   ```

3. **Docker Compose для Grafana** — файл `4 практ/grafana/docker-compose.yml`:
   ```yaml
   services:
     grafana:
       image: grafana/grafana:10.2.3
       container_name: grafana-practice
       restart: unless-stopped
       environment:
         GF_SECURITY_ADMIN_USER: admin
         GF_SECURITY_ADMIN_PASSWORD: admin123
       volumes:
         - ./data:/var/lib/grafana
         - ./plugins:/var/lib/grafana/plugins
         - ../data:/var/lib/grafana/host-data
         - ./provisioning:/etc/grafana/provisioning
       ports:
         - "3000:3000"
       networks:
         - grafana_net
   
   networks:
     grafana_net:
       external: true
   ```

4. **Плагины и провижининг**
   - Плагин для работы с SQLite (`frser-sqlite-datasource`) скопирован из контейнера в локальную папку `grafana/plugins` и монтируется внутрь контейнера.
   - Подготовлены каталоги `grafana/provisioning/datasources` и `grafana/provisioning/dashboards`.

5. **Запуск Grafana**
   ```bash
   cd "4 практ/grafana"
   docker compose up -d
   docker compose ps
   # grafana-practice   grafana/grafana:10.2.3   "/run.sh"   Up 0.0.0.0:3000->3000/tcp
   ```

6. **Проверка логов**
   ```bash
   docker logs grafana-practice --tail 40
   ```
   В логах присутствуют сообщения о том, что источники данных успешно вставлены (`inserting datasource from configuration`).

---

## ДОБАВЛЕНИЕ ИСТОЧНИКОВ ДАННЫХ

Источники создаются автоматически через провижининг-файл `grafana/provisioning/datasources/datasources.yaml`:
```yaml
apiVersion: 1

datasources:
  - name: Host SQLite
    uid: host-sqlite
    type: frser-sqlite-datasource
    jsonData:
      path: /var/lib/grafana/host-data/host_metrics.db
  - name: Docker PostgreSQL
    uid: docker-postgres
    type: postgres
    url: postgres-db:5432
    user: grafana
    jsonData:
      database: metrics
      sslmode: disable
    secureJsonData:
      password: grafana
  - name: Docker MySQL
    uid: docker-mysql
    type: mysql
    url: mysql-db:3306
    user: grafana
    jsonData:
      database: analytics
      tlsSkipVerify: true
    secureJsonData:
      password: grafana
```

Проверка через REST API:
```bash
curl -s -u admin:admin123 http://localhost:3000/api/datasources | jq '.[].name'
# "Docker MySQL"
# "Docker PostgreSQL"
# "Host SQLite"
```

---

## РАЗВЕРТЫВАНИЕ БАЗ ДАННЫХ В ОТДЕЛЬНОМ DOCKER-COMPOSE

Базы вынесены в отдельный файл `4 практ/databases/docker-compose.yml`, подключающийся к общей сети `grafana_net`:
```yaml
version: "3.9"

services:
  postgres-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: metrics
      POSTGRES_USER: grafana
      POSTGRES_PASSWORD: grafana
    volumes:
      - ./postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - postgres_data:/var/lib/postgresql/data
    networks:
      - grafana_net

  mysql-db:
    image: mysql:8.2
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: analytics
      MYSQL_USER: grafana
      MYSQL_PASSWORD: grafana
    command: ["--default-authentication-plugin=mysql_native_password",
              "--character-set-server=utf8mb4",
              "--collation-server=utf8mb4_unicode_ci"]
    volumes:
      - ./mysql/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - mysql_data:/var/lib/mysql
    networks:
      - grafana_net

volumes:
  postgres_data:
  mysql_data:

networks:
  grafana_net:
    external: true
```

Запуск и проверка:
```bash
cd "4 практ/databases"
docker compose up -d
docker compose ps
# postgres-practice   postgres:15-alpine   Up   5432/tcp
# mysql-practice      mysql:8.2            Up   3306/tcp, 33060/tcp
```

Инициализационные SQL-скрипты автоматически создают таблицы и тестовые данные при первом старте контейнеров:
- `databases/postgres/init.sql` — таблица `sensor_readings` (ts, temperature, humidity)
- `databases/mysql/init.sql` — таблица `energy_usage` (recorded_at, kilowatt_hours, location)

Проверка содержимого:
```bash
# PostgreSQL
docker exec postgres-practice psql -U grafana -d metrics -c "SELECT ts, temperature, humidity FROM sensor_readings;"

# MySQL
docker exec mysql-practice mysql -ugrafana -pgrafana -D analytics -e "SELECT recorded_at, kilowatt_hours FROM energy_usage;"
```

---

## ПОДГОТОВКА ЛОКАЛЬНОЙ БД НА ХОСТЕ

1. **Создание SQLite-базы** `4 практ/data/host_metrics.db`:
   ```bash
   cd "4 практ/data"
   sqlite3 host_metrics.db <<'SQL'
   DROP TABLE IF EXISTS local_metrics;
   CREATE TABLE local_metrics (
       id INTEGER PRIMARY KEY AUTOINCREMENT,
       captured_at TEXT NOT NULL,
       cpu_load REAL NOT NULL
   );
   INSERT INTO local_metrics (captured_at, cpu_load) VALUES
       ('2025-10-20T09:00:00', 35.2),
       ('2025-10-20T10:00:00', 42.7),
       ('2025-10-20T11:00:00', 39.4),
       ('2025-10-20T12:00:00', 44.1),
       ('2025-10-20T13:00:00', 47.9);
   SQL
   ```

2. **Проверка данных**
   ```bash
   sqlite3 host_metrics.db "SELECT captured_at, cpu_load FROM local_metrics;"
   # 2025-10-20T09:00:00|35.2
   # ...
   ```

3. **Подключение к Grafana**
   - Файл базы монтируется как `/var/lib/grafana/host-data/host_metrics.db` (см. docker-compose).
   - Плагин `frser-sqlite-datasource` установлен локально и доступен внутри контейнера через том `./plugins`.

Таким образом выполняется требование выгрузить данные напрямую с хоста (без Prometheus).

---

## ДАШБОРД И ВИЗУАЛИЗАЦИЯ

Дашборд провиженится автоматически (`grafana/provisioning/dashboards/practice4_dashboard.json`) и содержит три панели:
1. **PostgreSQL** — временной график температуры и влажности (`sensor_readings`).
2. **MySQL** — временной график потребления энергии (`energy_usage`).
3. **SQLite (хост)** — временной график загрузки CPU (`local_metrics`).

Проверка наличия дашборда через API:
```bash
curl -s -u admin:admin123 "http://localhost:3000/api/search?query=%D0%9F%D1%80%D0%B0%D0%BA%D1%82%D0%B8%D0%BA%D0%B0" | jq '.[].title'
# "Практика 4"
# "Практика 4: Мониторинг из разных источников"
```

Для корректной визуализации выполнены требования:
- Минимум один столбец типа *дата/время* и один *числовой* в каждой таблице.
- Данные отображаются графиками в Grafana Timeseries.
- Обновление дашборда настроено на `5m` (можно изменить в UI).

---

## ДОПОЛНИТЕЛЬНЫЕ МАТЕРИАЛЫ И СКРИНШОТЫ

Рекомендуемые скриншоты для отчета:
1. **Docker Desktop / CLI** — список контейнеров Grafana, PostgreSQL, MySQL.
2. **Grafana → Connections → Data sources** — три настроенных источника (`Host SQLite`, `Docker PostgreSQL`, `Docker MySQL`).
3. **Дашборд `Практика 4: Мониторинг из разных источников`** — общий вид графиков.
4. (Опционально) Просмотр данных в таблице `local_metrics` через SQL-консоль SQLite.

Скриншоты сохраняем в папку `4 практ/` с понятными именами и добавляем ссылки в данный раздел.

---

## ВЫВОДЫ

В ходе работы:
- Развернута Grafana в Docker с автоматическим провиженингом источников данных и дашборда.
- Настроено две базы данных в отдельном docker-compose файле (PostgreSQL и MySQL) с общей сетью `grafana_net`.
- Создана и подключена локальная SQLite-база на хосте для прямой выгрузки данных.
- Реализован дашборд, сочетающий данные из контейнеров и хост-машины; визуализация выполнена в виде временных графиков с датой и числовыми значениями.
- Выполнено требование использования БД, отличной от PostgreSQL (MySQL).

Система готова к дальнейшему расширению: можно добавлять новые источники, обновлять SQL-скрипты и настраивать тревоги в Grafana.

---
